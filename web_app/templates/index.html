<!-- web_app/templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eye Disease Classification System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-eye me-2"></i>Eye Disease Classifier
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/about">About</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/contact">Contact</a>
                    </li>
                    <li class="nav-item d-flex align-items-center ms-3">
                        {% if MODEL_LOADED %}
                        <span class="badge bg-success">Model: Loaded</span>
                        {% else %}
                        <span class="badge bg-danger" title="{{ MODEL_LOAD_ERROR }}">Model: Unavailable</span>
                        {% endif %}
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <header class="hero bg-primary text-white py-5">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6">
                    <h1 class="display-4 fw-bold mb-4">AI-Powered Eye Disease Detection</h1>
                    <p class="lead mb-4">Upload retinal images for instant classification of 10 different eye diseases with expert recommendations.</p>
                    <div class="d-flex gap-3">
                        <button class="btn btn-light btn-lg" onclick="scrollToUpload()">
                            <i class="fas fa-upload me-2"></i>Upload Image
                        </button>
                        <a href="#diseases" class="btn btn-outline-light btn-lg">
                            <i class="fas fa-info-circle me-2"></i>Learn More
                        </a>
                    </div>
                </div>
                <div class="col-lg-6 text-center">
                    <img src="{{ url_for('static', filename='uploads/picture.jpg') }}" 
                         alt="Eye Illustration" class="img-fluid" style="max-height: 300px;">
                </div>
            </div>
        </div>
    </header>

    <!-- Upload Section -->
    <section class="py-5" id="upload">
        <div class="container">
            {% if not MODEL_LOADED %}
            <div class="alert alert-warning" role="alert">
                <strong>Model not loaded:</strong> Predictions are unavailable right now. Admins: check server logs or <code>/status</code> for details.
            </div>
            {% endif %}
        </div>
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card shadow">
                        <div class="card-header bg-white">
                            <h3 class="mb-0"><i class="fas fa-cloud-upload-alt me-2"></i>Upload Retinal Image</h3>
                        </div>
                        <div class="card-body">
                            <div class="upload-area p-5 text-center border rounded" 
                                 id="dropArea"
                                 ondragover="handleDragOver(event)"
                                 ondragleave="handleDragLeave(event)"
                                 ondrop="handleDrop(event)">
                                <i class="fas fa-file-upload fa-3x text-muted mb-3"></i>
                                <h4>Drag & Drop your image here</h4>
                                <p class="text-muted mb-4">or click to browse</p>
                                <input type="file" id="imageInput" accept="image/*" class="d-none">
                                <button class="btn btn-primary" onclick="document.getElementById('imageInput').click()">
                                    <i class="fas fa-folder-open me-2"></i>Browse Files
                                </button>
                                <p class="mt-3 small text-muted">Supports: JPG, PNG, BMP, TIFF (Max 16MB)</p>
                            </div>
                            
                            <div class="mt-4" id="previewContainer" style="display: none;">
                                <h5>Image Preview:</h5>
                                <div class="text-center">
                                    <img id="imagePreview" class="img-fluid rounded shadow" 
                                         style="max-height: 300px;">
                                </div>
                                <div class="mt-3 text-center">
                                    <button class="btn btn-success" onclick="predictImage()">
                                        <i class="fas fa-brain me-2"></i>Analyze Image
                                    </button>
                                    <button class="btn btn-secondary" onclick="clearUpload()">
                                        <i class="fas fa-times me-2"></i>Clear
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mt-4" id="loading" style="display: none;">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Analyzing image... This may take a moment.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Results Section -->
    <section class="py-5 bg-light" id="results" style="display: none;">
        <div class="container">
            <h2 class="text-center mb-5">Analysis Results</h2>
            <div class="row">
                <div class="col-lg-4">
                    <div class="card shadow mb-4">
                        <div class="card-header bg-white">
                            <h4 class="mb-0"><i class="fas fa-image me-2"></i>Uploaded Image</h4>
                        </div>
                        <div class="card-body text-center">
                            <img id="resultImage" class="img-fluid rounded" style="max-height: 250px;">
                        </div>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="card shadow mb-4">
                        <div class="card-header bg-white">
                            <h4 class="mb-0"><i class="fas fa-diagnoses me-2"></i>Diagnosis Results</h4>
                        </div>
                        <div class="card-body">
                            <div id="predictionsContainer"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Diseases Info Section -->
    <section class="py-5" id="diseases">
        <div class="container">
            <h2 class="text-center mb-5">Detectable Eye Diseases</h2>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                {% for disease in diseases %}
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">{{ disease }}</h5>
                            <p class="card-text small text-muted">
                                {{ DISEASE_INFO[disease]['description'] if disease in DISEASE_INFO else 'No description available' }}
                            </p>
                        </div>
                        <div class="card-footer bg-transparent">
                            <small class="text-muted">
                                Severity: 
                                <span class="badge 
                                    {% if DISEASE_INFO[disease]['severity'] == 'Critical' %}bg-danger
                                    {% elif DISEASE_INFO[disease]['severity'] == 'High' %}bg-warning
                                    {% elif DISEASE_INFO[disease]['severity'] == 'Moderate' %}bg-info
                                    {% else %}bg-success{% endif %}">
                                    {{ DISEASE_INFO[disease]['severity'] if disease in DISEASE_INFO else 'Unknown' }}
                                </span>
                            </small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5><i class="fas fa-eye me-2"></i>Eye Disease Classification System</h5>
                    <p class="mb-0">Advanced AI solution for early detection of eye diseases.</p>
                </div>
                <div class="col-md-6 text-end">
                    <p class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <small>Note: This tool is for assistance only. Always consult a medical professional.</small>
                    </p>
                </div>
            </div>
            <hr class="bg-light">
            <div class="text-center">
                <p class="mb-0">&copy; 2024 Eye Disease Classification System. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let uploadedFile = null;
        
        // Drag and drop handlers
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.target.classList.add('bg-light');
        }
        
        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            e.target.classList.remove('bg-light');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            e.target.classList.remove('bg-light');
            
            const files = e.dataTransfer.files;
            if (files.length) {
                handleFileSelect(files[0]);
            }
        }
        
        // File input handler
        document.getElementById('imageInput').addEventListener('change', function(e) {
            if (this.files.length) {
                handleFileSelect(this.files[0]);
            }
        });
        
        function handleFileSelect(file) {
            if (!file.type.match('image.*')) {
                alert('Please select an image file.');
                return;
            }
            
            if (file.size > 16 * 1024 * 1024) {
                alert('File size must be less than 16MB.');
                return;
            }
            
            uploadedFile = file;
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('previewContainer').style.display = 'block';
                document.getElementById('dropArea').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
        
        function clearUpload() {
            uploadedFile = null;
            document.getElementById('imageInput').value = '';
            document.getElementById('previewContainer').style.display = 'none';
            document.getElementById('dropArea').style.display = 'block';
            document.getElementById('results').style.display = 'none';
        }
        
        function scrollToUpload() {
            document.getElementById('upload').scrollIntoView({ behavior: 'smooth' });
        }
        
        async function predictImage() {
            if (!uploadedFile) {
                alert('Please upload an image first.');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', uploadedFile);
            
            // Show loading
            document.getElementById('loading').style.display = 'block';
            
            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayResults(result);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error analyzing image: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        function displayResults(result) {
            // Show results section
            document.getElementById('results').style.display = 'block';
            
            // Display image
            document.getElementById('resultImage').src = result.image_url;
            
            // Display predictions
            const container = document.getElementById('predictionsContainer');
            container.innerHTML = '';
            
            result.predictions.forEach((pred, index) => {
                const confidencePercent = (pred.confidence * 100).toFixed(2);
                const severityColor = 
                    pred.severity === 'Critical' ? 'danger' :
                    pred.severity === 'High' ? 'warning' :
                    pred.severity === 'Moderate' ? 'info' :
                    pred.severity === 'Low' ? 'success' : 'secondary';
                
                const predictionHTML = `
                    <div class="prediction-item mb-4 p-3 border rounded ${index === 0 ? 'border-primary border-2' : ''}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="mb-0">
                                ${index + 1}. ${pred.disease}
                                ${index === 0 ? '<span class="badge bg-primary ms-2">Top Prediction</span>' : ''}
                            </h5>
                            <span class="badge bg-${severityColor}">${pred.severity}</span>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Confidence:</span>
                                <span class="fw-bold">${confidencePercent}%</span>
                            </div>
                            <div class="progress" style="height: 10px;">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: ${confidencePercent}%;" 
                                     aria-valuenow="${confidencePercent}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                </div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <strong><i class="fas fa-info-circle me-1"></i>Description:</strong>
                            <p class="mb-1">${pred.description}</p>
                        </div>
                        <div>
                            <strong><i class="fas fa-stethoscope me-1"></i>Recommendation:</strong>
                            <p class="mb-0 text-${severityColor}">${pred.recommendation}</p>
                        </div>
                    </div>
                `;
                
                container.innerHTML += predictionHTML;
            });
            
            // Scroll to results
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>